import { Component, Input, Output, EventEmitter, ChangeDetectionStrategy } from '@angular/core';
import { BehaviorSubject, Subscription } from 'rxjs';
import { map } from 'rxjs/operators';
import { ShareService, SHARE_BUTTONS } from 'ngx-sharebuttons';
export class ShareButtons {
    constructor(_share) {
        this._share = _share;
        this._state$ = new BehaviorSubject({
            includedButtons: [],
            excludedButtons: [],
            userButtons: [],
            selectedButtons: [],
            expanded: true,
            shownCount: Object.keys(SHARE_BUTTONS).length
        });
        this._configSub$ = Subscription.EMPTY;
        this.theme = this._share.config.theme;
        /** Show buttons icons */
        this.showIcon = true;
        /** Show buttons text */
        this.showText = false;
        /** Buttons size */
        this.size = 0;
        /** Share dialog opened event */
        this.opened = new EventEmitter();
        /** Share dialog closed event */
        this.closed = new EventEmitter();
    }
    ngOnInit() {
        this.state$ = this._state$.pipe(map((state) => {
            // Use component include buttons, otherwise fallback to global include buttons
            const includedButtons = state.includedButtons && state.includedButtons.length ? state.includedButtons : state.userButtons;
            const userButtons = state.excludedButtons ? includedButtons.filter((btn) => state.excludedButtons.indexOf(btn) < 0) : includedButtons;
            const selectedButtons = userButtons.slice(0, state.expanded ? userButtons.length : state.shownCount);
            return {
                userButtons,
                selectedButtons,
                expanded: state.expanded,
                shownCount: state.shownCount,
                moreIcon: state.moreIcon,
                lessIcon: state.lessIcon
            };
        }));
        // Subscribe to share buttons config changes, This updates the component whenever a new button is added
        this._configSub$ = this._share.config$.subscribe((config) => {
            // Use global include buttons, otherwise fallback to all buttons
            const includedButtons = config.include.length ? config.include : Object.keys(SHARE_BUTTONS);
            const userButtons = includedButtons.filter((btn) => config.exclude.indexOf(btn) < 0);
            this.updateState({
                userButtons,
                expanded: false,
                moreIcon: config.moreButtonIcon,
                lessIcon: config.lessButtonIcon
            });
        });
    }
    ngOnChanges(changes) {
        const shouldUpdate = (changes['include'] && changes['include'].currentValue !== changes['include'].previousValue) ||
            (changes['exclude'] && changes['exclude'].currentValue !== changes['exclude'].previousValue) ||
            (changes['show'] && changes['show'].currentValue !== changes['show'].previousValue);
        if (shouldUpdate) {
            this.updateState({
                includedButtons: this.include,
                excludedButtons: this.exclude,
                shownCount: this.show
            });
        }
    }
    ngOnDestroy() {
        this._configSub$.unsubscribe();
        this._state$.complete();
    }
    updateState(state) {
        this._state$.next(Object.assign(Object.assign({}, this._state$.value), state));
    }
}
ShareButtons.decorators = [
    { type: Component, args: [{
                selector: 'share-buttons',
                template: "<div *ngIf=\"state$ | async; let state\" class=\"sb-group sb-{{theme}}\">\n  <share-button *ngFor=\"let button of state.selectedButtons\"\n                [button]=\"button\"\n                [theme]=\"theme\"\n                [url]=\"url\"\n                [title]=\"title\"\n                [description]=\"description\"\n                [image]=\"image\"\n                [tags]=\"tags\"\n                [autoSetMeta]=\"autoSetMeta\"\n                [showIcon]=\"showIcon\"\n                [showText]=\"showText\"\n                [size]=\"size\"\n                (opened)=\"opened.emit($event)\"\n                (closed)=\"closed.emit($event)\"\n                [disabled]=\"disabled\">\n  </share-button>\n  <expand-button *ngIf=\"state.shownCount < state.userButtons.length\"\n                 class=\"sb-button sb-{{theme}}\"\n                 [expanded]=\"state.expanded\"\n                 [moreIcon]=\"state.moreIcon\"\n                 [lessIcon]=\"state.lessIcon\"\n                 [size]=\"(1 + size/20) * 14\"\n                 (toggle)=\"updateState({expanded: $event})\">\n  </expand-button>\n</div>\n",
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: [":host{--sb-margin:0.3125em;display:inherit}"]
            },] }
];
ShareButtons.ctorParameters = () => [
    { type: ShareService }
];
ShareButtons.propDecorators = {
    theme: [{ type: Input }],
    include: [{ type: Input }],
    exclude: [{ type: Input }],
    show: [{ type: Input }],
    url: [{ type: Input }],
    title: [{ type: Input }],
    description: [{ type: Input }],
    image: [{ type: Input }],
    tags: [{ type: Input }],
    autoSetMeta: [{ type: Input }],
    showIcon: [{ type: Input }],
    showText: [{ type: Input }],
    size: [{ type: Input }],
    disabled: [{ type: Input }],
    opened: [{ type: Output }],
    closed: [{ type: Output }]
};
/**
 * Explanation of the above code:
 * ------------------------------
 Include buttons: includes only wanted buttons and excludes the rest
 Exclude buttons: excludes only the unwanted buttons
 User buttons = Include buttons - exclude buttons
 Selected Buttons = User buttons [shown number]
 */
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhcmUtYnV0dG9ucy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtc2hhcmVidXR0b25zL2J1dHRvbnMvc3JjLyIsInNvdXJjZXMiOlsic2hhcmUtYnV0dG9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULEtBQUssRUFDTCxNQUFNLEVBSU4sWUFBWSxFQUVaLHVCQUF1QixFQUN4QixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQWMsZUFBZSxFQUFFLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqRSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFckMsT0FBTyxFQUFFLFlBQVksRUFBc0IsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFxQm5GLE1BQU0sT0FBTyxZQUFZO0lBNkR2QixZQUFvQixNQUFvQjtRQUFwQixXQUFNLEdBQU4sTUFBTSxDQUFjO1FBMURoQyxZQUFPLEdBQUcsSUFBSSxlQUFlLENBQWU7WUFDbEQsZUFBZSxFQUFFLEVBQUU7WUFDbkIsZUFBZSxFQUFFLEVBQUU7WUFDbkIsV0FBVyxFQUFFLEVBQUU7WUFDZixlQUFlLEVBQUUsRUFBRTtZQUNuQixRQUFRLEVBQUUsSUFBSTtZQUNkLFVBQVUsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLE1BQU07U0FDOUMsQ0FBQyxDQUFDO1FBRUssZ0JBQVcsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDO1FBRWhDLFVBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7UUE2QjFDLHlCQUF5QjtRQUNoQixhQUFRLEdBQUcsSUFBSSxDQUFDO1FBRXpCLHdCQUF3QjtRQUNmLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFFMUIsbUJBQW1CO1FBQ1YsU0FBSSxHQUFHLENBQUMsQ0FBQztRQUtsQixnQ0FBZ0M7UUFDdEIsV0FBTSxHQUFH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QkFDN0IsZUFBZSxFQUFFLElBQUksQ0FBQyxPQUFPO2dCQUM3QixVQUFVLEVBQUUsSUFBSSxDQUFDLElBQUk7YUFDdEIsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDO0lBRUQsV0FBVztRQUNULElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDL0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBRUQsV0FBVyxDQUFDLEtBQW1CO1FBQzdCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxpQ0FBSyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssR0FBSyxLQUFLLEVBQUUsQ0FBQztJQUN2RCxDQUFDOzs7WUE1SEYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxlQUFlO2dCQUN6Qiw4bUNBQW1DO2dCQUVuQyxlQUFlLEVBQUUsdUJBQXVCLENBQUMsTUFBTTs7YUFDaEQ7OztZQXBCUSxZQUFZOzs7b0JBbUNsQixLQUFLO3NCQUdMLEtBQUs7c0JBR0wsS0FBSzttQkFHTCxLQUFLO2tCQUdMLEtBQUs7b0JBR0wsS0FBSzswQkFHTCxLQUFLO29CQUdMLEtBQUs7bUJBR0wsS0FBSzswQkFHTCxLQUFLO3VCQUdMLEtBQUs7dUJBR0wsS0FBSzttQkFHTCxLQUFLO3VCQUdMLEtBQUs7cUJBR0wsTUFBTTtxQkFHTixNQUFNOztBQStEVDs7Ozs7OztHQU9HIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBPbkluaXQsXG4gIE9uQ2hhbmdlcyxcbiAgT25EZXN0cm95LFxuICBFdmVudEVtaXR0ZXIsXG4gIFNpbXBsZUNoYW5nZXMsXG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5XG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgQmVoYXZpb3JTdWJqZWN0LCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgU2hhcmVTZXJ2aWNlLCBTaGFyZUJ1dHRvbnNDb25maWcsIFNIQVJFX0JVVFRPTlMgfSBmcm9tICduZ3gtc2hhcmVidXR0b25zJztcbi8vIFVuY29tbWVudCB0aGUgZm9sbG93aW5nIGxpbmUgaW4gZGV2ZWxvcG1lbnQgbW9kZVxuLy8gaW1wb3J0IHsgU2hhcmVTZXJ2aWNlLCBTaGFyZUJ1dHRvbnNDb25maWcsIFNIQVJFX0JVVFRPTlMgfSBmcm9tICcuLi8uLi9zcmMvcHVibGljLWFwaSc7XG5cbmludGVyZmFjZSBCdXR0b25zU3RhdGUge1xuICBpbmNsdWRlZEJ1dHRvbnM/OiBzdHJpbmdbXTtcbiAgZXhjbHVkZWRCdXR0b25zPzogc3RyaW5nW107XG4gIHVzZXJCdXR0b25zPzogc3RyaW5nW107XG4gIHNlbGVjdGVkQnV0dG9ucz86IHN0cmluZ1tdO1xuICBleHBhbmRlZD86IGJvb2xlYW47XG4gIHNob3duQ291bnQ/OiBudW1iZXI7XG4gIG1vcmVJY29uPzogYW55O1xuICBsZXNzSWNvbj86IGFueTtcbn1cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnc2hhcmUtYnV0dG9ucycsXG4gIHRlbXBsYXRlVXJsOiAnLi9zaGFyZS1idXR0b25zLmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9zaGFyZS1idXR0b25zLnNjc3MnXSxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2hcbn0pXG5leHBvcnQgY2xhc3MgU2hhcmVCdXR0b25zIGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XG5cbiAgc3RhdGUkOiBPYnNlcnZhYmxlPEJ1dHRvbnNTdGF0ZT47XG4gIHByaXZhdGUgX3N0YXRlJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8QnV0dG9uc1N0YXRlPih7XG4gICAgaW5jbHVkZWRCdXR0b25zOiBbXSxcbiAgICBleGNsdWRlZEJ1dHRvbnM6IFtdLFxuICAgIHVzZXJCdXR0b25zOiBbXSxcbiAgICBzZWxlY3RlZEJ1dHRvbnM6IFtdLFxuICAgIGV4cGFuZGVkOiB0cnVlLFxuICAgIHNob3duQ291bnQ6IE9iamVjdC5rZXlzKFNIQVJFX0JVVFRPTlMpLmxlbmd0aFxuICB9KTtcblxuICBwcml2YXRlIF9jb25maWdTdWIkID0gU3Vic2NyaXB0aW9uLkVNUFRZO1xuXG4gIEBJbnB1dCgpIHRoZW1lID0gdGhpcy5fc2hhcmUuY29uZmlnLnRoZW1lO1xuXG4gIC8qKiBBcnJheSBvZiBpbmNsdWRlZCBidXR0b25zICovXG4gIEBJbnB1dCgpIGluY2x1ZGU6IHN0cmluZ1tdO1xuXG4gIC8qKiBBcnJheSBvZiBleGNsdWRlZCBidXR0b25zICovXG4gIEBJbnB1dCgpIGV4Y2x1ZGU6IHN0cmluZ1tdO1xuXG4gIC8qKiBOdW1iZXJzIG9mIGJ1dHRvbnMgdG8gc2hvdyAqL1xuICBASW5wdXQoKSBzaG93OiBudW1iZXI7XG5cbiAgLyoqIFRoZSBzaGFyaW5nIGxpbmsgKi9cbiAgQElucHV0KCkgdXJsOiBzdHJpbmc7XG5cbiAgLyoqIFRoZSB0aXRsZSBwYXJhbWV0ZXIgKi9cbiAgQElucHV0KCkgdGl0bGU6IHN0cmluZztcblxuICAvKiogVGhlIGRlc2NyaXB0aW9uIHBhcmFtZXRlciAqL1xuICBASW5wdXQoKSBkZXNjcmlwdGlvbjogc3RyaW5nO1xuXG4gIC8qKiBUaGUgaW1hZ2UgcGFyYW1ldGVyIGZvciBzaGFyaW5nIG9uIFBpbnRlcmVzdCAqL1xuICBASW5wdXQoKSBpbWFnZTogc3RyaW5nO1xuXG4gIC8qKiBUaGUgdGFncyBwYXJhbWV0ZXIgZm9yIHNoYXJpbmcgb24gVHdpdHRlciBhbmQgVHVtYmxyICovXG4gIEBJbnB1dCgpIHRhZ3M6IHN0cmluZztcblxuICAvKiogU2V0cyBtZXRhIHRhZ3MgZnJvbSBkb2N1bWVudCBoZWFkLCB1c2VmdWwgd2hlbiBTRU8gaXMgYXZhaWxhYmxlICovXG4gIEBJbnB1dCgpIGF1dG9TZXRNZXRhOiBib29sZWFuO1xuXG4gIC8qKiBTaG93IGJ1dHRvbnMgaWNvbnMgKi9cbiAgQElucHV0KCkgc2hvd0ljb24gPSB0cnVlO1xuXG4gIC8qKiBTaG93IGJ1dHRvbnMgdGV4dCAqL1xuICBASW5wdXQoKSBzaG93VGV4dCA9IGZhbHNlO1xuXG4gIC8qKiBCdXR0b25zIHNpemUgKi9cbiAgQElucHV0KCkgc2l6ZSA9IDA7XG5cbiAgLyoqIEEgZmxhZyB0aGF0IGluZGljYXRlcyBpZiB0aGUgYnV0dG9uJ3MgY2xpY2sgaXMgZGlzYWJsZWQgKi9cbiAgQElucHV0KCkgZGlzYWJsZWQ6IGJvb2xlYW47XG5cbiAgLyoqIFNoYXJlIGRpYWxvZyBvcGVuZWQgZXZlbnQgKi9cbiAgQE91dHB1dCgpIG9wZW5lZCA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xuXG4gIC8qKiBTaGFyZSBkaWFsb2cgY2xvc2VkIGV2ZW50ICovXG4gIEBPdXRwdXQoKSBjbG9zZWQgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9zaGFyZTogU2hhcmVTZXJ2aWNlKSB7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLnN0YXRlJCA9IHRoaXMuX3N0YXRlJC5waXBlKFxuICAgICAgbWFwKChzdGF0ZTogQnV0dG9uc1N0YXRlKSA9PiB7XG4gICAgICAgIC8vIFVzZSBjb21wb25lbnQgaW5jbHVkZSBidXR0b25zLCBvdGhlcndpc2UgZmFsbGJhY2sgdG8gZ2xvYmFsIGluY2x1ZGUgYnV0dG9uc1xuICAgICAgICBjb25zdCBpbmNsdWRlZEJ1dHRvbnMgPSBzdGF0ZS5pbmNsdWRlZEJ1dHRvbnMgJiYgc3RhdGUuaW5jbHVkZWRCdXR0b25zLmxlbmd0aCA/IHN0YXRlLmluY2x1ZGVkQnV0dG9ucyA6IHN0YXRlLnVzZXJCdXR0b25zO1xuICAgICAgICBjb25zdCB1c2VyQnV0dG9ucyA9IHN0YXRlLmV4Y2x1ZGVkQnV0dG9ucyA/IGluY2x1ZGVkQnV0dG9ucy5maWx0ZXIoKGJ0bikgPT4gc3RhdGUuZXhjbHVkZWRCdXR0b25zLmluZGV4T2YoYnRuKSA8IDApIDogaW5jbHVkZWRCdXR0b25zO1xuICAgICAgICBjb25zdCBzZWxlY3RlZEJ1dHRvbnMgPSB1c2VyQnV0dG9ucy5zbGljZSgwLCBzdGF0ZS5leHBhbmRlZCA/IHVzZXJCdXR0b25zLmxlbmd0aCA6IHN0YXRlLnNob3duQ291bnQpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHVzZXJCdXR0b25zLFxuICAgICAgICAgIHNlbGVjdGVkQnV0dG9ucyxcbiAgICAgICAgICBleHBhbmRlZDogc3RhdGUuZXhwYW5kZWQsXG4gICAgICAgICAgc2hvd25Db3VudDogc3RhdGUuc2hvd25Db3VudCxcbiAgICAgICAgICBtb3JlSWNvbjogc3RhdGUubW9yZUljb24sXG4gICAgICAgICAgbGVzc0ljb246IHN0YXRlLmxlc3NJY29uXG4gICAgICAgIH07XG4gICAgICB9KVxuICAgICk7XG5cbiAgICAvLyBTdWJzY3JpYmUgdG8gc2hhcmUgYnV0dG9ucyBjb25maWcgY2hhbmdlcywgVGhpcyB1cGRhdGVzIHRoZSBjb21wb25lbnQgd2hlbmV2ZXIgYSBuZXcgYnV0dG9uIGlzIGFkZGVkXG4gICAgdGhpcy5fY29uZmlnU3ViJCA9IHRoaXMuX3NoYXJlLmNvbmZpZyQuc3Vic2NyaWJlKChjb25maWc6IFNoYXJlQnV0dG9uc0NvbmZpZykgPT4ge1xuICAgICAgLy8gVXNlIGdsb2JhbCBpbmNsdWRlIGJ1dHRvbnMsIG90aGVyd2lzZSBmYWxsYmFjayB0byBhbGwgYnV0dG9uc1xuICAgICAgY29uc3QgaW5jbHVkZWRCdXR0b25zID0gY29uZmlnLmluY2x1ZGUubGVuZ3RoID8gY29uZmlnLmluY2x1ZGUgOiBPYmplY3Qua2V5cyhTSEFSRV9CVVRUT05TKTtcbiAgICAgIGNvbnN0IHVzZXJCdXR0b25zID0gaW5jbHVkZWRCdXR0b25zLmZpbHRlcigoYnRuKSA9PiBjb25maWcuZXhjbHVkZS5pbmRleE9mKGJ0bikgPCAwKTtcbiAgICAgIHRoaXMudXBkYXRlU3RhdGUoe1xuICAgICAgICB1c2VyQnV0dG9ucyxcbiAgICAgICAgZXhwYW5kZWQ6IGZhbHNlLFxuICAgICAgICBtb3JlSWNvbjogY29uZmlnLm1vcmVCdXR0b25JY29uLFxuICAgICAgICBsZXNzSWNvbjogY29uZmlnLmxlc3NCdXR0b25JY29uXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBjb25zdCBzaG91bGRVcGRhdGUgPVxuICAgICAgKGNoYW5nZXNbJ2luY2x1ZGUnXSAmJiBjaGFuZ2VzWydpbmNsdWRlJ10uY3VycmVudFZhbHVlICE9PSBjaGFuZ2VzWydpbmNsdWRlJ10ucHJldmlvdXNWYWx1ZSkgfHxcbiAgICAgIChjaGFuZ2VzWydleGNsdWRlJ10gJiYgY2hhbmdlc1snZXhjbHVkZSddLmN1cnJlbnRWYWx1ZSAhPT0gY2hhbmdlc1snZXhjbHVkZSddLnByZXZpb3VzVmFsdWUpIHx8XG4gICAgICAoY2hhbmdlc1snc2hvdyddICYmIGNoYW5nZXNbJ3Nob3cnXS5jdXJyZW50VmFsdWUgIT09IGNoYW5nZXNbJ3Nob3cnXS5wcmV2aW91c1ZhbHVlKTtcblxuICAgIGlmIChzaG91bGRVcGRhdGUpIHtcbiAgICAgIHRoaXMudXBkYXRlU3RhdGUoe1xuICAgICAgICBpbmNsdWRlZEJ1dHRvbnM6IHRoaXMuaW5jbHVkZSxcbiAgICAgICAgZXhjbHVkZWRCdXR0b25zOiB0aGlzLmV4Y2x1ZGUsXG4gICAgICAgIHNob3duQ291bnQ6IHRoaXMuc2hvd1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5fY29uZmlnU3ViJC51bnN1YnNjcmliZSgpO1xuICAgIHRoaXMuX3N0YXRlJC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgdXBkYXRlU3RhdGUoc3RhdGU6IEJ1dHRvbnNTdGF0ZSkge1xuICAgIHRoaXMuX3N0YXRlJC5uZXh0KHsuLi50aGlzLl9zdGF0ZSQudmFsdWUsIC4uLnN0YXRlfSk7XG4gIH1cblxufVxuXG4vKipcbiAqIEV4cGxhbmF0aW9uIG9mIHRoZSBhYm92ZSBjb2RlOlxuICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gSW5jbHVkZSBidXR0b25zOiBpbmNsdWRlcyBvbmx5IHdhbnRlZCBidXR0b25zIGFuZCBleGNsdWRlcyB0aGUgcmVzdFxuIEV4Y2x1ZGUgYnV0dG9uczogZXhjbHVkZXMgb25seSB0aGUgdW53YW50ZWQgYnV0dG9uc1xuIFVzZXIgYnV0dG9ucyA9IEluY2x1ZGUgYnV0dG9ucyAtIGV4Y2x1ZGUgYnV0dG9uc1xuIFNlbGVjdGVkIEJ1dHRvbnMgPSBVc2VyIGJ1dHRvbnMgW3Nob3duIG51bWJlcl1cbiAqL1xuIl19