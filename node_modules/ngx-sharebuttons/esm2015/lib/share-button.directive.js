import { Directive, Input, Output, HostListener, Inject, EventEmitter, ElementRef, ChangeDetectorRef } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { Meta } from '@angular/platform-browser';
import { Platform } from '@angular/cdk/platform';
import { Clipboard } from '@angular/cdk/clipboard';
import { EMPTY, Observable, Subject } from 'rxjs';
import { takeUntil, tap } from 'rxjs/operators';
import { ShareService } from './share.service';
import { SharerMethod } from './share.models';
import { getValidUrl } from './utils';
export class ShareDirective {
    constructor(_el, _meta, _platform, _clipboard, _share, _cd, _document) {
        this._meta = _meta;
        this._platform = _platform;
        this._clipboard = _clipboard;
        this._share = _share;
        this._cd = _cd;
        this._document = _document;
        /** Stream that emits when button is destroyed */
        this._destroyed = new Subject();
        /** Stream that emit when share button need to be updated */
        this._updater = new Subject();
        /** Set meta tags from document head, useful when SEO is supported */
        this.autoSetMeta = this._share.config.autoSetMeta;
        /** Sharing link */
        this.url = this._share.config.url;
        /** Sets the title parameter */
        this.title = this._share.config.title;
        /** Sets the description parameter */
        this.description = this._share.config.description;
        /** Sets the image parameter for sharing on Pinterest */
        this.image = this._share.config.image;
        /** Sets the tags parameter for sharing on Twitter and Tumblr */
        this.tags = this._share.config.tags;
        /** Stream that emits when share dialog is opened */
        this.opened = new EventEmitter();
        /** Stream that emits when share dialog is closed */
        this.closed = new EventEmitter();
        this._el = _el.nativeElement;
    }
    /**
     * Share the link
     */
    share() {
        // Avoid SSR error
        if (this._platform.isBrowser && this.shareButton) {
            // Prepare sharer url params
            const params = this.autoSetMeta ? this.getParamsFromMetaTags() : this.getParamsFromInputs();
            // Prepare share button click
            const click = this.shareButton.share ? this.open(params) : this.shareButton.func({
                params,
                data: this.shareButton.data,
                clipboard: this._clipboard,
                updater: this._updater
            });
            click.pipe(takeUntil(this._destroyed)).subscribe();
        }
        else {
            console.warn(`${this.text} button is not compatible on this Platform`);
        }
    }
    ngOnInit() {
        // This stream is mainly used to update the copy button text and icon when it is being clicked
        this._updater.pipe(tap((data) => {
            this.icon = data.icon;
            this.text = data.text;
            this._el.style.pointerEvents = data.disabled ? 'none' : 'auto';
            this._cd.markForCheck();
        }), takeUntil(this._destroyed)).subscribe();
    }
    ngOnChanges(changes) {
        // Avoid SSR error
        if (this._platform.isBrowser) {
            // Create share button
            if (this._shareButtonChanged(changes.shareButtonName)) {
                this._createShareButton();
            }
            // Prepare share url
            if (this._urlChanged(changes.url)) {
                this.url = getValidUrl(this.autoSetMeta
                    ? this.url || this._getMetaTagContent('og:url')
                    : this.url, this._document.defaultView.location.href);
            }
        }
    }
    ngOnDestroy() {
        this._destroyed.next();
        this._destroyed.complete();
    }
    _createShareButton() {
        const button = this._share.config.prop[this.shareButtonName];
        if (button) {
            // Set share button properties
            this.shareButton = button;
            // Remove previous button class
            this._el.classList.remove(`sb-${this._buttonClass}`);
            // Add new button class
            this._el.classList.add(`sb-${this.shareButtonName}`);
            // Set button css color variable
            this._el.style.setProperty('--button-color', this.shareButton.color);
            // Keep a copy of the class for future replacement
            this._buttonClass = this.shareButtonName;
            this.color = this.shareButton.color;
            this.text = this.shareButton.text;
            this.icon = this.shareButton.icon;
            // Set aria-label attribute
            this._el.setAttribute('aria-label', button.ariaLabel);
        }
        else {
            console.error(`[ShareButtons]: The share button '${this.shareButtonName}' does not exist!`);
        }
    }
    /**
     * Get meta tag content
     */
    _getMetaTagContent(key) {
        const metaUsingProperty = this._meta.getTag(`property="${key}"`);
        if (metaUsingProperty) {
            return metaUsingProperty.getAttribute('content');
        }
        const metaUsingName = this._meta.getTag(`name="${key}"`);
        if (metaUsingName) {
            return metaUsingName.getAttribute('content');
        }
    }
    _shareButtonChanged(change) {
        return change && (change.firstChange || change.previousValue !== change.currentValue);
    }
    _urlChanged(change) {
        return !this.url || (change && change.previousValue !== change.currentValue);
    }
    /**
     * Get share params from meta tags first and fallback to user inputs
     */
    getParamsFromMetaTags() {
        return {
            url: this.url,
            title: this.title || this._getMetaTagContent('og:title'),
            description: this.description || this._getMetaTagContent('og:description'),
            image: this.image || this._getMetaTagContent('og:image'),
            via: this._share.config.twitterAccount,
            tags: this.tags
        };
    }
    /**
     * Get share params from user inputs
     */
    getParamsFromInputs() {
        return {
            url: this.url,
            title: this.title,
            description: this.description,
            image: this.image,
            tags: this.tags,
            via: this._share.config.twitterAccount,
        };
    }
    open(params) {
        // Set sharer link based on user's device
        let sharerLink;
        if (this._platform.IOS && this.shareButton.share.ios) {
            sharerLink = this.shareButton.share.ios;
        }
        else if (this._platform.ANDROID && this.shareButton.share.android) {
            sharerLink = this.shareButton.share.android;
        }
        else {
            sharerLink = this.shareButton.share.desktop;
        }
        if (sharerLink) {
            // Set sharer link params
            this._finalUrl = sharerLink + this._serializeParams(params);
            // Log the sharer link in debug mode
            if (this._share.config.debug) {
                console.log('[DEBUG SHARE BUTTON]: ', this._finalUrl);
            }
            // Open the share window
            // There are two methods available for opening the share window:
            // 1. Using a real anchor
            // 2. Using window.open
            const sharerMethod = this.shareButton.method || this._share.config.sharerMethod;
            const sharerTarget = this.shareButton.target || this._share.config.sharerTarget;
            switch (sharerMethod) {
                case SharerMethod.Anchor:
                    const linkElement = this._document.createElement('a');
                    // Make it open in a new tab/window (depends on user's browser configuration)
                    linkElement.setAttribute('target', sharerTarget);
                    // Prevent security vulnerability https://medium.com/@jitbit/target-blank-the-most-underestimated-vulnerability-ever-96e328301f4c
                    linkElement.setAttribute('rel', 'noopener noreferrer');
                    linkElement.href = this._finalUrl;
                    linkElement.click();
                    linkElement.remove();
                    break;
                case SharerMethod.Window:
                    // Open link using Window object
                    const openWindow = this._share.config.windowObj[this._share.config.windowFuncName];
                    const popUpWindow = openWindow(this._finalUrl, sharerTarget, this._share.windowSize);
                    // Prevent security vulnerability https://medium.com/@jitbit/target-blank-the-most-underestimated-vulnerability-ever-96e328301f4c
                    this._share.config.windowObj.opener = null;
                    // Resolve when share dialog is closed
                    if (popUpWindow) {
                        return new Observable((sub) => {
                            const pollTimer = this._document.defaultView.setInterval(() => {
                                if (popUpWindow.closed) {
                                    this._document.defaultView.clearInterval(pollTimer);
                                    // Emit when share windows is closed
                                    this.closed.emit(this.shareButtonName);
                                    sub.next();
                                    sub.complete();
                                }
                            }, 200);
                        });
                    }
                    break;
            }
            // Emit when share window is opened
            this.opened.emit(this.shareButtonName);
        }
        return EMPTY;
    }
    _serializeParams(params) {
        return Object.entries(this.shareButton.params)
            .map(([key, value]) => {
            // Check if share button param has a map function
            const paramFunc = this.shareButton.paramsFunc ? this.shareButton.paramsFunc[key] : null;
            if (params[key] || paramFunc) {
                const paramValue = paramFunc ? paramFunc(params) : params[key];
                return `${value}=${encodeURIComponent(paramValue)}`;
            }
            return '';
        })
            .filter(urlParam => urlParam !== '')
            .join('&');
    }
}
ShareDirective.decorators = [
    { type: Directive, args: [{
                selector: '[shareButton]',
                exportAs: 'shareButton'
            },] }
];
ShareDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Meta },
    { type: Platform },
    { type: Clipboard },
    { type: ShareService },
    { type: ChangeDetectorRef },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
ShareDirective.propDecorators = {
    shareButtonName: [{ type: Input, args: ['shareButton',] }],
    autoSetMeta: [{ type: Input }],
    url: [{ type: Input }],
    title: [{ type: Input }],
    description: [{ type: Input }],
    image: [{ type: Input }],
    tags: [{ type: Input }],
    opened: [{ type: Output }],
    closed: [{ type: Output }],
    share: [{ type: HostListener, args: ['click',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhcmUtYnV0dG9uLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLi9wcm9qZWN0cy9uZ3gtc2hhcmVidXR0b25zL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9zaGFyZS1idXR0b24uZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEVBQ1osTUFBTSxFQU1OLFlBQVksRUFDWixVQUFVLEVBQ1YsaUJBQWlCLEVBQ2xCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDakQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ2pELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNuRCxPQUFPLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDOUQsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVoRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDL0MsT0FBTyxFQUFxRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNqSCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBTXRDLE1BQU0sT0FBTyxjQUFjO0lBd0R6QixZQUFZLEdBQWUsRUFDUCxLQUFXLEVBQ1gsU0FBbUIsRUFDbkIsVUFBcUIsRUFDckIsTUFBb0IsRUFDcEIsR0FBc0IsRUFDSixTQUFjO1FBTGhDLFVBQUssR0FBTCxLQUFLLENBQU07UUFDWCxjQUFTLEdBQVQsU0FBUyxDQUFVO1FBQ25CLGVBQVUsR0FBVixVQUFVLENBQVc7UUFDckIsV0FBTSxHQUFOLE1BQU0s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QUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxRQUFRLEtBQUssRUFBRSxDQUFDO2FBQ25DLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNiLENBQUM7OztZQTFTRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLGVBQWU7Z0JBQ3pCLFFBQVEsRUFBRSxhQUFhO2FBQ3hCOzs7WUFqQkMsVUFBVTtZQUlILElBQUk7WUFDSixRQUFRO1lBQ1IsU0FBUztZQUlULFlBQVk7WUFUbkIsaUJBQWlCOzRDQStFSixNQUFNLFNBQUMsUUFBUTs7OzhCQWhDM0IsS0FBSyxTQUFDLGFBQWE7MEJBR25CLEtBQUs7a0JBR0wsS0FBSztvQkFHTCxLQUFLOzBCQUdMLEtBQUs7b0JBR0wsS0FBSzttQkFHTCxLQUFLO3FCQUdMLE1BQU07cUJBR04sTUFBTTtvQkFlTixZQUFZLFNBQUMsT0FBTyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERpcmVjdGl2ZSxcbiAgSW5wdXQsXG4gIE91dHB1dCxcbiAgSG9zdExpc3RlbmVyLFxuICBJbmplY3QsXG4gIE9uSW5pdCxcbiAgT25DaGFuZ2VzLFxuICBPbkRlc3Ryb3ksXG4gIFNpbXBsZUNoYW5nZXMsXG4gIFNpbXBsZUNoYW5nZSxcbiAgRXZlbnRFbWl0dGVyLFxuICBFbGVtZW50UmVmLFxuICBDaGFuZ2VEZXRlY3RvclJlZlxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IE1ldGEgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyJztcbmltcG9ydCB7IFBsYXRmb3JtIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3BsYXRmb3JtJztcbmltcG9ydCB7IENsaXBib2FyZCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9jbGlwYm9hcmQnO1xuaW1wb3J0IHsgRU1QVFksIE9ic2VydmFibGUsIFN1YmplY3QsIFN1YnNjcmliZXIgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRha2VVbnRpbCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBTaGFyZVNlcnZpY2UgfSBmcm9tICcuL3NoYXJlLnNlcnZpY2UnO1xuaW1wb3J0IHsgSVNoYXJlQnV0dG9uLCBTaGFyZURpcmVjdGl2ZVVwZGF0ZXIsIFNoYXJlUGFyYW1zLCBTaGFyZVBhcmFtc0Z1bmMsIFNoYXJlck1ldGhvZCB9IGZyb20gJy4vc2hhcmUubW9kZWxzJztcbmltcG9ydCB7IGdldFZhbGlkVXJsIH0gZnJvbSAnLi91dGlscyc7XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1tzaGFyZUJ1dHRvbl0nLFxuICBleHBvcnRBczogJ3NoYXJlQnV0dG9uJ1xufSlcbmV4cG9ydCBjbGFzcyBTaGFyZURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuXG4gIC8qKiBWYXJpYWJsZSB1c2VkIHRvIGNoZWNrIGZvciB0aGUgZmluYWwgc2hhcmVyIHVybCAoRm9yIHRlc3Rpbmcgb25seSkgKi9cbiAgcHJpdmF0ZSBfZmluYWxVcmw6IHN0cmluZztcblxuICAvKiogU2hhcmUgZGlyZWN0aXZlIGVsZW1lbnQgcmVmICovXG4gIHByaXZhdGUgcmVhZG9ubHkgX2VsOiBIVE1MQnV0dG9uRWxlbWVudDtcblxuICAvKiogQSByZWYgdG8gYnV0dG9uIGNsYXNzIC0gdXNlZCB0byByZW1vdmUgcHJldmlvdXMgY2xhc3Mgd2hlbiB0aGUgYnV0dG9uIHR5cGUgaXMgY2hhbmdlZCAqL1xuICBwcml2YXRlIF9idXR0b25DbGFzczogc3RyaW5nO1xuXG4gIC8qKiBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIGJ1dHRvbiBpcyBkZXN0cm95ZWQgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBfZGVzdHJveWVkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcblxuICAvKiogU3RyZWFtIHRoYXQgZW1pdCB3aGVuIHNoYXJlIGJ1dHRvbiBuZWVkIHRvIGJlIHVwZGF0ZWQgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBfdXBkYXRlciA9IG5ldyBTdWJqZWN0PFNoYXJlRGlyZWN0aXZlVXBkYXRlcj4oKTtcblxuICAvKiogU2hhcmUgYnV0dG9uIHByb3BlcnRpZXMgKi9cbiAgc2hhcmVCdXR0b246IElTaGFyZUJ1dHRvbjtcblxuICAvKiogU2hhcmUgYnV0dG9uIGNvbG9yICovXG4gIGNvbG9yOiBzdHJpbmc7XG5cbiAgLyoqIFNoYXJlIGJ1dHRvbiB0ZXh0ICovXG4gIHRleHQ6IHN0cmluZztcblxuICAvKiogU2hhcmUgYnV0dG9uIGljb24gKi9cbiAgaWNvbjogc3RyaW5nIHwgc3RyaW5nW107XG5cbiAgLyoqIFNoYXJlIGJ1dHRvbiB0eXBlICovXG4gIEBJbnB1dCgnc2hhcmVCdXR0b24nKSBzaGFyZUJ1dHRvbk5hbWU6IHN0cmluZztcblxuICAvKiogU2V0IG1ldGEgdGFncyBmcm9tIGRvY3VtZW50IGhlYWQsIHVzZWZ1bCB3aGVuIFNFTyBpcyBzdXBwb3J0ZWQgKi9cbiAgQElucHV0KCkgYXV0b1NldE1ldGE6IGJvb2xlYW4gPSB0aGlzLl9zaGFyZS5jb25maWcuYXV0b1NldE1ldGE7XG5cbiAgLyoqIFNoYXJpbmcgbGluayAqL1xuICBASW5wdXQoKSB1cmw6IHN0cmluZyA9IHRoaXMuX3NoYXJlLmNvbmZpZy51cmw7XG5cbiAgLyoqIFNldHMgdGhlIHRpdGxlIHBhcmFtZXRlciAqL1xuICBASW5wdXQoKSB0aXRsZTogc3RyaW5nID0gdGhpcy5fc2hhcmUuY29uZmlnLnRpdGxlO1xuXG4gIC8qKiBTZXRzIHRoZSBkZXNjcmlwdGlvbiBwYXJhbWV0ZXIgKi9cbiAgQElucHV0KCkgZGVzY3JpcHRpb246IHN0cmluZyA9IHRoaXMuX3NoYXJlLmNvbmZpZy5kZXNjcmlwdGlvbjtcblxuICAvKiogU2V0cyB0aGUgaW1hZ2UgcGFyYW1ldGVyIGZvciBzaGFyaW5nIG9uIFBpbnRlcmVzdCAqL1xuICBASW5wdXQoKSBpbWFnZTogc3RyaW5nID0gdGhpcy5fc2hhcmUuY29uZmlnLmltYWdlO1xuXG4gIC8qKiBTZXRzIHRoZSB0YWdzIHBhcmFtZXRlciBmb3Igc2hhcmluZyBvbiBUd2l0dGVyIGFuZCBUdW1ibHIgKi9cbiAgQElucHV0KCkgdGFnczogc3RyaW5nID0gdGhpcy5fc2hhcmUuY29uZmlnLnRhZ3M7XG5cbiAgLyoqIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gc2hhcmUgZGlhbG9nIGlzIG9wZW5lZCAqL1xuICBAT3V0cHV0KCkgb3BlbmVkID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XG5cbiAgLyoqIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gc2hhcmUgZGlhbG9nIGlzIGNsb3NlZCAqL1xuICBAT3V0cHV0KCkgY2xvc2VkID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XG5cbiAgY29uc3RydWN0b3IoX2VsOiBFbGVtZW50UmVmLFxuICAgICAgICAgICAgICBwcml2YXRlIF9tZXRhOiBNZXRhLFxuICAgICAgICAgICAgICBwcml2YXRlIF9wbGF0Zm9ybTogUGxhdGZvcm0sXG4gICAgICAgICAgICAgIHByaXZhdGUgX2NsaXBib2FyZDogQ2xpcGJvYXJkLFxuICAgICAgICAgICAgICBwcml2YXRlIF9zaGFyZTogU2hhcmVTZXJ2aWNlLFxuICAgICAgICAgICAgICBwcml2YXRlIF9jZDogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgICAgICAgICAgIEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgX2RvY3VtZW50OiBhbnkpIHtcbiAgICB0aGlzLl9lbCA9IF9lbC5uYXRpdmVFbGVtZW50O1xuICB9XG5cbiAgLyoqXG4gICAqIFNoYXJlIHRoZSBsaW5rXG4gICAqL1xuICBASG9zdExpc3RlbmVyKCdjbGljaycpXG4gIHNoYXJlKCkge1xuICAgIC8vIEF2b2lkIFNTUiBlcnJvclxuICAgIGlmICh0aGlzLl9wbGF0Zm9ybS5pc0Jyb3dzZXIgJiYgdGhpcy5zaGFyZUJ1dHRvbikge1xuICAgICAgLy8gUHJlcGFyZSBzaGFyZXIgdXJsIHBhcmFtc1xuICAgICAgY29uc3QgcGFyYW1zOiBTaGFyZVBhcmFtcyA9IHRoaXMuYXV0b1NldE1ldGEgPyB0aGlzLmdldFBhcmFtc0Zyb21NZXRhVGFncygpIDogdGhpcy5nZXRQYXJhbXNGcm9tSW5wdXRzKCk7XG5cbiAgICAgIC8vIFByZXBhcmUgc2hhcmUgYnV0dG9uIGNsaWNrXG4gICAgICBjb25zdCBjbGljayA9IHRoaXMuc2hhcmVCdXR0b24uc2hhcmUgPyB0aGlzLm9wZW4ocGFyYW1zKSA6IHRoaXMuc2hhcmVCdXR0b24uZnVuYyh7XG4gICAgICAgIHBhcmFtcyxcbiAgICAgICAgZGF0YTogdGhpcy5zaGFyZUJ1dHRvbi5kYXRhLFxuICAgICAgICBjbGlwYm9hcmQ6IHRoaXMuX2NsaXBib2FyZCxcbiAgICAgICAgdXBkYXRlcjogdGhpcy5fdXBkYXRlclxuICAgICAgfSk7XG5cbiAgICAgIGNsaWNrLnBpcGUodGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3llZCkpLnN1YnNjcmliZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLndhcm4oYCR7IHRoaXMudGV4dCB9IGJ1dHRvbiBpcyBub3QgY29tcGF0aWJsZSBvbiB0aGlzIFBsYXRmb3JtYCk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgLy8gVGhpcyBzdHJlYW0gaXMgbWFpbmx5IHVzZWQgdG8gdXBkYXRlIHRoZSBjb3B5IGJ1dHRvbiB0ZXh0IGFuZCBpY29uIHdoZW4gaXQgaXMgYmVpbmcgY2xpY2tlZFxuICAgIHRoaXMuX3VwZGF0ZXIucGlwZShcbiAgICAgIHRhcCgoZGF0YTogYW55KSA9PiB7XG4gICAgICAgIHRoaXMuaWNvbiA9IGRhdGEuaWNvbjtcbiAgICAgICAgdGhpcy50ZXh0ID0gZGF0YS50ZXh0O1xuICAgICAgICB0aGlzLl9lbC5zdHlsZS5wb2ludGVyRXZlbnRzID0gZGF0YS5kaXNhYmxlZCA/ICdub25lJyA6ICdhdXRvJztcbiAgICAgICAgdGhpcy5fY2QubWFya0ZvckNoZWNrKCk7XG4gICAgICB9KSxcbiAgICAgIHRha2VVbnRpbCh0aGlzLl9kZXN0cm95ZWQpXG4gICAgKS5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICAvLyBBdm9pZCBTU1IgZXJyb3JcbiAgICBpZiAodGhpcy5fcGxhdGZvcm0uaXNCcm93c2VyKSB7XG5cbiAgICAgIC8vIENyZWF0ZSBzaGFyZSBidXR0b25cbiAgICAgIGlmICh0aGlzLl9zaGFyZUJ1dHRvbkNoYW5nZWQoY2hhbmdlcy5zaGFyZUJ1dHRvbk5hbWUpKSB7XG4gICAgICAgIHRoaXMuX2NyZWF0ZVNoYXJlQnV0dG9uKCk7XG4gICAgICB9XG4gICAgICAvLyBQcmVwYXJlIHNoYXJlIHVybFxuICAgICAgaWYgKHRoaXMuX3VybENoYW5nZWQoY2hhbmdlcy51cmwpKSB7XG4gICAgICAgIHRoaXMudXJsID0gZ2V0VmFsaWRVcmwoXG4gICAgICAgICAgdGhpcy5hdXRvU2V0TWV0YVxuICAgICAgICAgICAgPyB0aGlzLnVybCB8fCB0aGlzLl9nZXRNZXRhVGFnQ29udGVudCgnb2c6dXJsJylcbiAgICAgICAgICAgIDogdGhpcy51cmwsXG4gICAgICAgICAgdGhpcy5fZG9jdW1lbnQuZGVmYXVsdFZpZXcubG9jYXRpb24uaHJlZlxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuX2Rlc3Ryb3llZC5uZXh0KCk7XG4gICAgdGhpcy5fZGVzdHJveWVkLmNvbXBsZXRlKCk7XG4gIH1cblxuICBwcml2YXRlIF9jcmVhdGVTaGFyZUJ1dHRvbigpIHtcbiAgICBjb25zdCBidXR0b246IElTaGFyZUJ1dHRvbiA9IHRoaXMuX3NoYXJlLmNvbmZpZy5wcm9wW3RoaXMuc2hhcmVCdXR0b25OYW1lXTtcbiAgICBpZiAoYnV0dG9uKSB7XG4gICAgICAvLyBTZXQgc2hhcmUgYnV0dG9uIHByb3BlcnRpZXNcbiAgICAgIHRoaXMuc2hhcmVCdXR0b24gPSBidXR0b247XG5cbiAgICAgIC8vIFJlbW92ZSBwcmV2aW91cyBidXR0b24gY2xhc3NcbiAgICAgIHRoaXMuX2VsLmNsYXNzTGlzdC5yZW1vdmUoYHNiLSR7IHRoaXMuX2J1dHRvbkNsYXNzIH1gKTtcblxuICAgICAgLy8gQWRkIG5ldyBidXR0b24gY2xhc3NcbiAgICAgIHRoaXMuX2VsLmNsYXNzTGlzdC5hZGQoYHNiLSR7IHRoaXMuc2hhcmVCdXR0b25OYW1lIH1gKTtcblxuICAgICAgLy8gU2V0IGJ1dHRvbiBjc3MgY29sb3IgdmFyaWFibGVcbiAgICAgIHRoaXMuX2VsLnN0eWxlLnNldFByb3BlcnR5KCctLWJ1dHRvbi1jb2xvcicsIHRoaXMuc2hhcmVCdXR0b24uY29sb3IpO1xuXG4gICAgICAvLyBLZWVwIGEgY29weSBvZiB0aGUgY2xhc3MgZm9yIGZ1dHVyZSByZXBsYWNlbWVudFxuICAgICAgdGhpcy5fYnV0dG9uQ2xhc3MgPSB0aGlzLnNoYXJlQnV0dG9uTmFtZTtcblxuICAgICAgdGhpcy5jb2xvciA9IHRoaXMuc2hhcmVCdXR0b24uY29sb3I7XG4gICAgICB0aGlzLnRleHQgPSB0aGlzLnNoYXJlQnV0dG9uLnRleHQ7XG4gICAgICB0aGlzLmljb24gPSB0aGlzLnNoYXJlQnV0dG9uLmljb247XG5cbiAgICAgIC8vIFNldCBhcmlhLWxhYmVsIGF0dHJpYnV0ZVxuICAgICAgdGhpcy5fZWwuc2V0QXR0cmlidXRlKCdhcmlhLWxhYmVsJywgYnV0dG9uLmFyaWFMYWJlbCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYFtTaGFyZUJ1dHRvbnNdOiBUaGUgc2hhcmUgYnV0dG9uICckeyB0aGlzLnNoYXJlQnV0dG9uTmFtZSB9JyBkb2VzIG5vdCBleGlzdCFgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IG1ldGEgdGFnIGNvbnRlbnRcbiAgICovXG4gIHByaXZhdGUgX2dldE1ldGFUYWdDb250ZW50KGtleTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBtZXRhVXNpbmdQcm9wZXJ0eTogSFRNTE1ldGFFbGVtZW50ID0gdGhpcy5fbWV0YS5nZXRUYWcoYHByb3BlcnR5PVwiJHsga2V5IH1cImApO1xuICAgIGlmIChtZXRhVXNpbmdQcm9wZXJ0eSkge1xuICAgICAgcmV0dXJuIG1ldGFVc2luZ1Byb3BlcnR5LmdldEF0dHJpYnV0ZSgnY29udGVudCcpO1xuICAgIH1cbiAgICBjb25zdCBtZXRhVXNpbmdOYW1lOiBIVE1MTWV0YUVsZW1lbnQgPSB0aGlzLl9tZXRhLmdldFRhZyhgbmFtZT1cIiR7IGtleSB9XCJgKTtcbiAgICBpZiAobWV0YVVzaW5nTmFtZSkge1xuICAgICAgcmV0dXJuIG1ldGFVc2luZ05hbWUuZ2V0QXR0cmlidXRlKCdjb250ZW50Jyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfc2hhcmVCdXR0b25DaGFuZ2VkKGNoYW5nZTogU2ltcGxlQ2hhbmdlKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGNoYW5nZSAmJiAoY2hhbmdlLmZpcnN0Q2hhbmdlIHx8IGNoYW5nZS5wcmV2aW91c1ZhbHVlICE9PSBjaGFuZ2UuY3VycmVudFZhbHVlKTtcbiAgfVxuXG4gIHByaXZhdGUgX3VybENoYW5nZWQoY2hhbmdlOiBTaW1wbGVDaGFuZ2UpOiBib29sZWFuIHtcbiAgICByZXR1cm4gIXRoaXMudXJsIHx8IChjaGFuZ2UgJiYgY2hhbmdlLnByZXZpb3VzVmFsdWUgIT09IGNoYW5nZS5jdXJyZW50VmFsdWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBzaGFyZSBwYXJhbXMgZnJvbSBtZXRhIHRhZ3MgZmlyc3QgYW5kIGZhbGxiYWNrIHRvIHVzZXIgaW5wdXRzXG4gICAqL1xuICBwcml2YXRlIGdldFBhcmFtc0Zyb21NZXRhVGFncygpOiBTaGFyZVBhcmFtcyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHVybDogdGhpcy51cmwsXG4gICAgICB0aXRsZTogdGhpcy50aXRsZSB8fCB0aGlzLl9nZXRNZXRhVGFnQ29udGVudCgnb2c6dGl0bGUnKSxcbiAgICAgIGRlc2NyaXB0aW9uOiB0aGlzLmRlc2NyaXB0aW9uIHx8IHRoaXMuX2dldE1ldGFUYWdDb250ZW50KCdvZzpkZXNjcmlwdGlvbicpLFxuICAgICAgaW1hZ2U6IHRoaXMuaW1hZ2UgfHwgdGhpcy5fZ2V0TWV0YVRhZ0NvbnRlbnQoJ29nOmltYWdlJyksXG4gICAgICB2aWE6IHRoaXMuX3NoYXJlLmNvbmZpZy50d2l0dGVyQWNjb3VudCxcbiAgICAgIHRhZ3M6IHRoaXMudGFnc1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2V0IHNoYXJlIHBhcmFtcyBmcm9tIHVzZXIgaW5wdXRzXG4gICAqL1xuICBwcml2YXRlIGdldFBhcmFtc0Zyb21JbnB1dHMoKTogU2hhcmVQYXJhbXMge1xuICAgIHJldHVybiB7XG4gICAgICB1cmw6IHRoaXMudXJsLFxuICAgICAgdGl0bGU6IHRoaXMudGl0bGUsXG4gICAgICBkZXNjcmlwdGlvbjogdGhpcy5kZXNjcmlwdGlvbixcbiAgICAgIGltYWdlOiB0aGlzLmltYWdlLFxuICAgICAgdGFnczogdGhpcy50YWdzLFxuICAgICAgdmlhOiB0aGlzLl9zaGFyZS5jb25maWcudHdpdHRlckFjY291bnQsXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgb3BlbihwYXJhbXM6IFNoYXJlUGFyYW1zKTogT2JzZXJ2YWJsZTx2b2lkPiB7XG4gICAgLy8gU2V0IHNoYXJlciBsaW5rIGJhc2VkIG9uIHVzZXIncyBkZXZpY2VcbiAgICBsZXQgc2hhcmVyTGluazogc3RyaW5nO1xuICAgIGlmICh0aGlzLl9wbGF0Zm9ybS5JT1MgJiYgdGhpcy5zaGFyZUJ1dHRvbi5zaGFyZS5pb3MpIHtcbiAgICAgIHNoYXJlckxpbmsgPSB0aGlzLnNoYXJlQnV0dG9uLnNoYXJlLmlvcztcbiAgICB9IGVsc2UgaWYgKHRoaXMuX3BsYXRmb3JtLkFORFJPSUQgJiYgdGhpcy5zaGFyZUJ1dHRvbi5zaGFyZS5hbmRyb2lkKSB7XG4gICAgICBzaGFyZXJMaW5rID0gdGhpcy5zaGFyZUJ1dHRvbi5zaGFyZS5hbmRyb2lkO1xuICAgIH0gZWxzZSB7XG4gICAgICBzaGFyZXJMaW5rID0gdGhpcy5zaGFyZUJ1dHRvbi5zaGFyZS5kZXNrdG9wO1xuICAgIH1cblxuICAgIGlmIChzaGFyZXJMaW5rKSB7XG4gICAgICAvLyBTZXQgc2hhcmVyIGxpbmsgcGFyYW1zXG4gICAgICB0aGlzLl9maW5hbFVybCA9IHNoYXJlckxpbmsgKyB0aGlzLl9zZXJpYWxpemVQYXJhbXMocGFyYW1zKTtcblxuICAgICAgLy8gTG9nIHRoZSBzaGFyZXIgbGluayBpbiBkZWJ1ZyBtb2RlXG4gICAgICBpZiAodGhpcy5fc2hhcmUuY29uZmlnLmRlYnVnKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdbREVCVUcgU0hBUkUgQlVUVE9OXTogJywgdGhpcy5fZmluYWxVcmwpO1xuICAgICAgfVxuXG4gICAgICAvLyBPcGVuIHRoZSBzaGFyZSB3aW5kb3dcbiAgICAgIC8vIFRoZXJlIGFyZSB0d28gbWV0aG9kcyBhdmFpbGFibGUgZm9yIG9wZW5pbmcgdGhlIHNoYXJlIHdpbmRvdzpcbiAgICAgIC8vIDEuIFVzaW5nIGEgcmVhbCBhbmNob3JcbiAgICAgIC8vIDIuIFVzaW5nIHdpbmRvdy5vcGVuXG4gICAgICBjb25zdCBzaGFyZXJNZXRob2QgPSB0aGlzLnNoYXJlQnV0dG9uLm1ldGhvZCB8fCB0aGlzLl9zaGFyZS5jb25maWcuc2hhcmVyTWV0aG9kO1xuICAgICAgY29uc3Qgc2hhcmVyVGFyZ2V0ID0gdGhpcy5zaGFyZUJ1dHRvbi50YXJnZXQgfHwgdGhpcy5fc2hhcmUuY29uZmlnLnNoYXJlclRhcmdldDtcblxuICAgICAgc3dpdGNoIChzaGFyZXJNZXRob2QpIHtcblxuICAgICAgICBjYXNlIFNoYXJlck1ldGhvZC5BbmNob3I6XG4gICAgICAgICAgY29uc3QgbGlua0VsZW1lbnQ6IEhUTUxMaW5rRWxlbWVudCA9IHRoaXMuX2RvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTtcbiAgICAgICAgICAvLyBNYWtlIGl0IG9wZW4gaW4gYSBuZXcgdGFiL3dpbmRvdyAoZGVwZW5kcyBvbiB1c2VyJ3MgYnJvd3NlciBjb25maWd1cmF0aW9uKVxuICAgICAgICAgIGxpbmtFbGVtZW50LnNldEF0dHJpYnV0ZSgndGFyZ2V0Jywgc2hhcmVyVGFyZ2V0KTtcblxuICAgICAgICAgIC8vIFByZXZlbnQgc2VjdXJpdHkgdnVsbmVyYWJpbGl0eSBodHRwczovL21lZGl1bS5jb20vQGppdGJpdC90YXJnZXQtYmxhbmstdGhlLW1vc3QtdW5kZXJlc3RpbWF0ZWQtdnVsbmVyYWJpbGl0eS1ldmVyLTk2ZTMyODMwMWY0Y1xuICAgICAgICAgIGxpbmtFbGVtZW50LnNldEF0dHJpYnV0ZSgncmVsJywgJ25vb3BlbmVyIG5vcmVmZXJyZXInKTtcbiAgICAgICAgICBsaW5rRWxlbWVudC5ocmVmID0gdGhpcy5fZmluYWxVcmw7XG4gICAgICAgICAgbGlua0VsZW1lbnQuY2xpY2soKTtcbiAgICAgICAgICBsaW5rRWxlbWVudC5yZW1vdmUoKTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIFNoYXJlck1ldGhvZC5XaW5kb3c6XG4gICAgICAgICAgLy8gT3BlbiBsaW5rIHVzaW5nIFdpbmRvdyBvYmplY3RcbiAgICAgICAgICBjb25zdCBvcGVuV2luZG93ID0gdGhpcy5fc2hhcmUuY29uZmlnLndpbmRvd09ialt0aGlzLl9zaGFyZS5jb25maWcud2luZG93RnVuY05hbWVdO1xuICAgICAgICAgIGNvbnN0IHBvcFVwV2luZG93ID0gb3BlbldpbmRvdyh0aGlzLl9maW5hbFVybCwgc2hhcmVyVGFyZ2V0LCB0aGlzLl9zaGFyZS53aW5kb3dTaXplKTtcblxuICAgICAgICAgIC8vIFByZXZlbnQgc2VjdXJpdHkgdnVsbmVyYWJpbGl0eSBodHRwczovL21lZGl1bS5jb20vQGppdGJpdC90YXJnZXQtYmxhbmstdGhlLW1vc3QtdW5kZXJlc3RpbWF0ZWQtdnVsbmVyYWJpbGl0eS1ldmVyLTk2ZTMyODMwMWY0Y1xuICAgICAgICAgIHRoaXMuX3NoYXJlLmNvbmZpZy53aW5kb3dPYmoub3BlbmVyID0gbnVsbDtcblxuICAgICAgICAgIC8vIFJlc29sdmUgd2hlbiBzaGFyZSBkaWFsb2cgaXMgY2xvc2VkXG4gICAgICAgICAgaWYgKHBvcFVwV2luZG93KSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IE9ic2VydmFibGU8dm9pZD4oKHN1YjogU3Vic2NyaWJlcjx2b2lkPikgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBwb2xsVGltZXIgPSB0aGlzLl9kb2N1bWVudC5kZWZhdWx0Vmlldy5zZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHBvcFVwV2luZG93LmNsb3NlZCkge1xuICAgICAgICAgICAgICAgICAgdGhpcy5fZG9jdW1lbnQuZGVmYXVsdFZpZXcuY2xlYXJJbnRlcnZhbChwb2xsVGltZXIpO1xuXG4gICAgICAgICAgICAgICAgICAvLyBFbWl0IHdoZW4gc2hhcmUgd2luZG93cyBpcyBjbG9zZWRcbiAgICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VkLmVtaXQodGhpcy5zaGFyZUJ1dHRvbk5hbWUpO1xuICAgICAgICAgICAgICAgICAgc3ViLm5leHQoKTtcbiAgICAgICAgICAgICAgICAgIHN1Yi5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSwgMjAwKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cblxuICAgICAgLy8gRW1pdCB3aGVuIHNoYXJlIHdpbmRvdyBpcyBvcGVuZWRcbiAgICAgIHRoaXMub3BlbmVkLmVtaXQodGhpcy5zaGFyZUJ1dHRvbk5hbWUpO1xuICAgIH1cbiAgICByZXR1cm4gRU1QVFk7XG4gIH1cblxuICBwcml2YXRlIF9zZXJpYWxpemVQYXJhbXMocGFyYW1zOiBTaGFyZVBhcmFtcyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIE9iamVjdC5lbnRyaWVzKHRoaXMuc2hhcmVCdXR0b24ucGFyYW1zKVxuICAgIC5tYXAoKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgLy8gQ2hlY2sgaWYgc2hhcmUgYnV0dG9uIHBhcmFtIGhhcyBhIG1hcCBmdW5jdGlvblxuICAgICAgY29uc3QgcGFyYW1GdW5jOiBTaGFyZVBhcmFtc0Z1bmMgPSB0aGlzLnNoYXJlQnV0dG9uLnBhcmFtc0Z1bmMgPyB0aGlzLnNoYXJlQnV0dG9uLnBhcmFtc0Z1bmNba2V5XSA6IG51bGw7XG5cbiAgICAgIGlmIChwYXJhbXNba2V5XSB8fCBwYXJhbUZ1bmMpIHtcbiAgICAgICAgY29uc3QgcGFyYW1WYWx1ZSA9IHBhcmFtRnVuYyA/IHBhcmFtRnVuYyhwYXJhbXMpIDogcGFyYW1zW2tleV07XG4gICAgICAgIHJldHVybiBgJHsgdmFsdWUgfT0keyBlbmNvZGVVUklDb21wb25lbnQocGFyYW1WYWx1ZSkgfWA7XG4gICAgICB9XG4gICAgICByZXR1cm4gJyc7XG4gICAgfSlcbiAgICAuZmlsdGVyKHVybFBhcmFtID0+IHVybFBhcmFtICE9PSAnJylcbiAgICAuam9pbignJicpO1xuICB9XG59XG4iXX0=