import { Subject, BehaviorSubject, timer, of, combineLatest, Subscription, EMPTY } from 'rxjs';
import { tap, delay, debounce, switchMap, takeUntil, finalize, filter } from 'rxjs/operators';
export class NgProgressRef {
    constructor(customConfig, _onDestroyCallback) {
        this._onDestroyCallback = _onDestroyCallback;
        // Progress start source event (used to cancel finalizing delays)
        this._started = new Subject();
        // Progress start event: stream that emits only when it hasn't already started
        this.started = this._started.pipe(filter(() => !this.isStarted));
        // Progress ended source event
        this._completed = new Subject();
        // Progress start event: stream that emits only when it has already started
        this.completed = this._completed.pipe(filter(() => this.isStarted));
        // Stream that increments and updates the progress state
        this._trickling = new Subject();
        // Stream that combines "_trickling" and "config" streams
        this._worker = Subscription.EMPTY;
        this._state = new BehaviorSubject({ active: false, value: 0 });
        this._config = new BehaviorSubject(customConfig);
        this.state = this._state.asObservable();
        this.config = this._config.asObservable();
        this._worker = combineLatest([this._trickling, this._config]).pipe(debounce(([start, config]) => timer(start ? config.debounceTime : 0)), switchMap(([start, config]) => start ? this.onTrickling(config) : this.onComplete(config))).subscribe();
    }
    // Get current progress state
    get snapshot() {
        return this._state.value;
    }
    // Check if progress has started
    get isStarted() {
        return this.snapshot.active;
    }
    /**
     * Start the progress
     */
    start() {
        this._started.next();
        this._trickling.next(true);
    }
    /**
     * Complete the progress
     */
    complete() {
        this._trickling.next(false);
    }
    /**
     * Increment the progress
     */
    inc(amount) {
        const n = this.snapshot.value;
        if (!this.isStarted) {
            this.start();
        }
        else {
            if (typeof amount !== 'number') {
                amount = this._config.value.trickleFunc(n);
            }
            this.set(n + amount);
        }
    }
    /**
     * Set the progress
     */
    set(n) {
        this.setState({ value: this.clamp(n), active: true });
    }
    /**
     * Set config
     */
    setConfig(config) {
        this._config.next(Object.assign(Object.assign({}, this._config.value), config));
    }
    /**
     * Destroy progress reference
     */
    destroy() {
        this._worker.unsubscribe();
        this._trickling.complete();
        this._state.complete();
        this._config.complete();
        this._started.complete();
        this._completed.complete();
        this._onDestroyCallback();
    }
    /**
     * Set progress state
     */
    setState(state) {
        this._state.next(Object.assign(Object.assign({}, this.snapshot), state));
    }
    /**
     * Clamps a value to be between min and max
     */
    clamp(n) {
        return Math.max(this._config.value.min, Math.min(this._config.value.max, n));
    }
    /**
     * Keeps incrementing the progress
     */
    onTrickling(config) {
        if (!this.isStarted) {
            this.set(this._config.value.min);
        }
        return timer(0, config.trickleSpeed).pipe(tap(() => this.inc()));
    }
    /**
     * Completes then resets the progress
     */
    onComplete(config) {
        this._completed.next();
        return !this.isStarted ? EMPTY : of({}).pipe(
        // Complete the progress
        tap(() => this.setState({ value: 100 })), 
        // Deactivate the progress after a tiny delay
        delay(config.speed * 1.7), tap(() => this.setState({ active: false })), 
        // Use a tiny delay before resetting
        delay(config.speed), 
        // Force the progress to reset even it got cancelled
        finalize(() => this.setState({ value: 0 })), 
        // Cancel any of the finalizing delays if the progress has started again
        takeUntil(this._started));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctcHJvZ3Jlc3MtcmVmLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uL3Byb2plY3RzL25neC1wcm9ncmVzc2Jhci9zcmMvIiwic291cmNlcyI6WyJsaWIvbmctcHJvZ3Jlc3MtcmVmLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBYyxPQUFPLEVBQUUsZUFBZSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsYUFBYSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0csT0FBTyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzlGLE1BQU0sT0FBTyxhQUFhO0lBb0N4QixZQUFZLFlBQTRCLEVBQVUsa0JBQThCO1FBQTlCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBWTtRQTFCaEYsaUVBQWlFO1FBQ2hELGFBQVEsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQzFDLDhFQUE4RTtRQUNyRSxZQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFFckUsOEJBQThCO1FBQ2IsZUFBVSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7UUFDNUMsMkVBQTJFO1FBQ2xFLGNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFFeEUsd0RBQXdEO1FBQ3ZDLGVBQVUsR0FBRyxJQUFJLE9BQU8sRUFBVyxDQUFDO1FBRXJELHlEQUF5RDtRQUN4QyxZQUFPLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQztRQWE1QyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUks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RUFBRSxDQUFDLENBQUMsSUFBSTtRQUMxQyx3QkFBd0I7UUFDeEIsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUV4Qyw2Q0FBNkM7UUFDN0MsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDLEVBQ3pCLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFFM0Msb0NBQW9DO1FBQ3BDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ25CLG9EQUFvRDtRQUNwRCxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzNDLHdFQUF3RTtRQUN4RSxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUN6QixDQUFDO0lBQ0osQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCwgQmVoYXZpb3JTdWJqZWN0LCB0aW1lciwgb2YsIGNvbWJpbmVMYXRlc3QsIFN1YnNjcmlwdGlvbiwgRU1QVFkgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRhcCwgZGVsYXksIGRlYm91bmNlLCBzd2l0Y2hNYXAsIHRha2VVbnRpbCwgZmluYWxpemUsIGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IE5nUHJvZ3Jlc3NTdGF0ZSwgTmdQcm9ncmVzc0NvbmZpZywgUHJvZ3Jlc3NDb25maWcsIFByb2dyZXNzU3RhdGUgfSBmcm9tICcuL25nLXByb2dyZXNzLmludGVyZmFjZSc7XG5cbmV4cG9ydCBjbGFzcyBOZ1Byb2dyZXNzUmVmIHtcblxuICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHByb2dyZXNzIHN0YXRlIGlzIGNoYW5nZWRcbiAgcHJpdmF0ZSByZWFkb25seSBfc3RhdGU6IEJlaGF2aW9yU3ViamVjdDxQcm9ncmVzc1N0YXRlPjtcbiAgc3RhdGU6IE9ic2VydmFibGU8UHJvZ3Jlc3NTdGF0ZT47XG5cbiAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBjb25maWcgaXMgY2hhbmdlZFxuICBwcml2YXRlIHJlYWRvbmx5IF9jb25maWc6IEJlaGF2aW9yU3ViamVjdDxQcm9ncmVzc0NvbmZpZz47XG4gIGNvbmZpZzogT2JzZXJ2YWJsZTxQcm9ncmVzc0NvbmZpZz47XG5cbiAgLy8gUHJvZ3Jlc3Mgc3RhcnQgc291cmNlIGV2ZW50ICh1c2VkIHRvIGNhbmNlbCBmaW5hbGl6aW5nIGRlbGF5cylcbiAgcHJpdmF0ZSByZWFkb25seSBfc3RhcnRlZCA9IG5ldyBTdWJqZWN0KCk7XG4gIC8vIFByb2dyZXNzIHN0YXJ0IGV2ZW50OiBzdHJlYW0gdGhhdCBlbWl0cyBvbmx5IHdoZW4gaXQgaGFzbid0IGFscmVhZHkgc3RhcnRlZFxuICByZWFkb25seSBzdGFydGVkID0gdGhpcy5fc3RhcnRlZC5waXBlKGZpbHRlcigoKSA9PiAhdGhpcy5pc1N0YXJ0ZWQpKTtcblxuICAvLyBQcm9ncmVzcyBlbmRlZCBzb3VyY2UgZXZlbnRcbiAgcHJpdmF0ZSByZWFkb25seSBfY29tcGxldGVkID0gbmV3IFN1YmplY3QoKTtcbiAgLy8gUHJvZ3Jlc3Mgc3RhcnQgZXZlbnQ6IHN0cmVhbSB0aGF0IGVtaXRzIG9ubHkgd2hlbiBpdCBoYXMgYWxyZWFkeSBzdGFydGVkXG4gIHJlYWRvbmx5IGNvbXBsZXRlZCA9IHRoaXMuX2NvbXBsZXRlZC5waXBlKGZpbHRlcigoKSA9PiB0aGlzLmlzU3RhcnRlZCkpO1xuXG4gIC8vIFN0cmVhbSB0aGF0IGluY3JlbWVudHMgYW5kIHVwZGF0ZXMgdGhlIHByb2dyZXNzIHN0YXRlXG4gIHByaXZhdGUgcmVhZG9ubHkgX3RyaWNrbGluZyA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XG5cbiAgLy8gU3RyZWFtIHRoYXQgY29tYmluZXMgXCJfdHJpY2tsaW5nXCIgYW5kIFwiY29uZmlnXCIgc3RyZWFtc1xuICBwcml2YXRlIHJlYWRvbmx5IF93b3JrZXIgPSBTdWJzY3JpcHRpb24uRU1QVFk7XG5cbiAgLy8gR2V0IGN1cnJlbnQgcHJvZ3Jlc3Mgc3RhdGVcbiAgcHJpdmF0ZSBnZXQgc25hcHNob3QoKTogUHJvZ3Jlc3NTdGF0ZSB7XG4gICAgcmV0dXJuIHRoaXMuX3N0YXRlLnZhbHVlO1xuICB9XG5cbiAgLy8gQ2hlY2sgaWYgcHJvZ3Jlc3MgaGFzIHN0YXJ0ZWRcbiAgZ2V0IGlzU3RhcnRlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5zbmFwc2hvdC5hY3RpdmU7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihjdXN0b21Db25maWc6IFByb2dyZXNzQ29uZmlnLCBwcml2YXRlIF9vbkRlc3Ryb3lDYWxsYmFjazogKCkgPT4gdm9pZCkge1xuICAgIHRoaXMuX3N0YXRlID0gbmV3IEJlaGF2aW9yU3ViamVjdDxQcm9ncmVzc1N0YXRlPih7IGFjdGl2ZTogZmFsc2UsIHZhbHVlOiAwIH0pO1xuICAgIHRoaXMuX2NvbmZpZyA9IG5ldyBCZWhhdmlvclN1YmplY3Q8UHJvZ3Jlc3NDb25maWc+KGN1c3RvbUNvbmZpZyk7XG4gICAgdGhpcy5zdGF0ZSA9IHRoaXMuX3N0YXRlLmFzT2JzZXJ2YWJsZSgpO1xuICAgIHRoaXMuY29uZmlnID0gdGhpcy5fY29uZmlnLmFzT2JzZXJ2YWJsZSgpO1xuXG4gICAgdGhpcy5fd29ya2VyID0gY29tYmluZUxhdGVzdChbdGhpcy5fdHJpY2tsaW5nLCB0aGlzLl9jb25maWddKS5waXBlKFxuICAgICAgZGVib3VuY2UoKFtzdGFydCwgY29uZmlnXTogW2Jvb2xlYW4sIFByb2dyZXNzQ29uZmlnXSkgPT4gdGltZXIoc3RhcnQgPyBjb25maWcuZGVib3VuY2VUaW1lIDogMCkpLFxuICAgICAgc3dpdGNoTWFwKChbc3RhcnQsIGNvbmZpZ106IFtib29sZWFuLCBQcm9ncmVzc0NvbmZpZ10pID0+IHN0YXJ0ID8gdGhpcy5vblRyaWNrbGluZyhjb25maWcpIDogdGhpcy5vbkNvbXBsZXRlKGNvbmZpZykpXG4gICAgKS5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydCB0aGUgcHJvZ3Jlc3NcbiAgICovXG4gIHN0YXJ0KCkge1xuICAgIHRoaXMuX3N0YXJ0ZWQubmV4dCgpO1xuICAgIHRoaXMuX3RyaWNrbGluZy5uZXh0KHRydWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbXBsZXRlIHRoZSBwcm9ncmVzc1xuICAgKi9cbiAgY29tcGxldGUoKSB7XG4gICAgdGhpcy5fdHJpY2tsaW5nLm5leHQoZmFsc2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIEluY3JlbWVudCB0aGUgcHJvZ3Jlc3NcbiAgICovXG4gIGluYyhhbW91bnQ/OiBudW1iZXIpIHtcbiAgICBjb25zdCBuID0gdGhpcy5zbmFwc2hvdC52YWx1ZTtcbiAgICBpZiAoIXRoaXMuaXNTdGFydGVkKSB7XG4gICAgICB0aGlzLnN0YXJ0KCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0eXBlb2YgYW1vdW50ICE9PSAnbnVtYmVyJykge1xuICAgICAgICBhbW91bnQgPSB0aGlzLl9jb25maWcudmFsdWUudHJpY2tsZUZ1bmMobik7XG4gICAgICB9XG4gICAgICB0aGlzLnNldChuICsgYW1vdW50KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSBwcm9ncmVzc1xuICAgKi9cbiAgc2V0KG46IG51bWJlcikge1xuICAgIHRoaXMuc2V0U3RhdGUoeyB2YWx1ZTogdGhpcy5jbGFtcChuKSwgYWN0aXZlOiB0cnVlIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBjb25maWdcbiAgICovXG4gIHNldENvbmZpZyhjb25maWc6IE5nUHJvZ3Jlc3NDb25maWcpIHtcbiAgICB0aGlzLl9jb25maWcubmV4dCh7IC4uLnRoaXMuX2NvbmZpZy52YWx1ZSwgLi4uY29uZmlnIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIERlc3Ryb3kgcHJvZ3Jlc3MgcmVmZXJlbmNlXG4gICAqL1xuICBkZXN0cm95KCkge1xuICAgIHRoaXMuX3dvcmtlci51bnN1YnNjcmliZSgpO1xuICAgIHRoaXMuX3RyaWNrbGluZy5jb21wbGV0ZSgpO1xuICAgIHRoaXMuX3N0YXRlLmNvbXBsZXRlKCk7XG4gICAgdGhpcy5fY29uZmlnLmNvbXBsZXRlKCk7XG4gICAgdGhpcy5fc3RhcnRlZC5jb21wbGV0ZSgpO1xuICAgIHRoaXMuX2NvbXBsZXRlZC5jb21wbGV0ZSgpO1xuICAgIHRoaXMuX29uRGVzdHJveUNhbGxiYWNrKCk7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHByb2dyZXNzIHN0YXRlXG4gICAqL1xuICBwcml2YXRlIHNldFN0YXRlKHN0YXRlOiBOZ1Byb2dyZXNzU3RhdGUpIHtcbiAgICB0aGlzLl9zdGF0ZS5uZXh0KHsgLi4udGhpcy5zbmFwc2hvdCwgLi4uc3RhdGUgfSk7XG4gIH1cblxuICAvKipcbiAgICogQ2xhbXBzIGEgdmFsdWUgdG8gYmUgYmV0d2VlbiBtaW4gYW5kIG1heFxuICAgKi9cbiAgcHJpdmF0ZSBjbGFtcChuOiBudW1iZXIpOiBudW1iZXIge1xuICAgIHJldHVybiBNYXRoLm1heCh0aGlzLl9jb25maWcudmFsdWUubWluLCBNYXRoLm1pbih0aGlzLl9jb25maWcudmFsdWUubWF4LCBuKSk7XG4gIH1cblxuICAvKipcbiAgICogS2VlcHMgaW5jcmVtZW50aW5nIHRoZSBwcm9ncmVzc1xuICAgKi9cbiAgcHJpdmF0ZSBvblRyaWNrbGluZyhjb25maWc6IFByb2dyZXNzQ29uZmlnKTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICBpZiAoIXRoaXMuaXNTdGFydGVkKSB7XG4gICAgICB0aGlzLnNldCh0aGlzLl9jb25maWcudmFsdWUubWluKTtcbiAgICB9XG4gICAgcmV0dXJuIHRpbWVyKDAsIGNvbmZpZy50cmlja2xlU3BlZWQpLnBpcGUodGFwKCgpID0+IHRoaXMuaW5jKCkpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb21wbGV0ZXMgdGhlbiByZXNldHMgdGhlIHByb2dyZXNzXG4gICAqL1xuICBwcml2YXRlIG9uQ29tcGxldGUoY29uZmlnOiBQcm9ncmVzc0NvbmZpZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgdGhpcy5fY29tcGxldGVkLm5leHQoKTtcbiAgICByZXR1cm4gIXRoaXMuaXNTdGFydGVkID8gRU1QVFkgOiBvZih7fSkucGlwZShcbiAgICAgIC8vIENvbXBsZXRlIHRoZSBwcm9ncmVzc1xuICAgICAgdGFwKCgpID0+IHRoaXMuc2V0U3RhdGUoeyB2YWx1ZTogMTAwIH0pKSxcblxuICAgICAgLy8gRGVhY3RpdmF0ZSB0aGUgcHJvZ3Jlc3MgYWZ0ZXIgYSB0aW55IGRlbGF5XG4gICAgICBkZWxheShjb25maWcuc3BlZWQgKiAxLjcpLFxuICAgICAgdGFwKCgpID0+IHRoaXMuc2V0U3RhdGUoeyBhY3RpdmU6IGZhbHNlIH0pKSxcblxuICAgICAgLy8gVXNlIGEgdGlueSBkZWxheSBiZWZvcmUgcmVzZXR0aW5nXG4gICAgICBkZWxheShjb25maWcuc3BlZWQpLFxuICAgICAgLy8gRm9yY2UgdGhlIHByb2dyZXNzIHRvIHJlc2V0IGV2ZW4gaXQgZ290IGNhbmNlbGxlZFxuICAgICAgZmluYWxpemUoKCkgPT4gdGhpcy5zZXRTdGF0ZSh7IHZhbHVlOiAwIH0pKSxcbiAgICAgIC8vIENhbmNlbCBhbnkgb2YgdGhlIGZpbmFsaXppbmcgZGVsYXlzIGlmIHRoZSBwcm9ncmVzcyBoYXMgc3RhcnRlZCBhZ2FpblxuICAgICAgdGFrZVVudGlsKHRoaXMuX3N0YXJ0ZWQpXG4gICAgKTtcbiAgfVxufVxuIl19